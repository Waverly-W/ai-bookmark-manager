# 快速参考：P0 优化指南

## 🚀 快速开始

### 安装依赖
```bash
npm install
```

### 开发模式
```bash
npm run dev
```

### 运行测试
```bash
npm test              # 运行所有测试
npm run test:ui      # UI 界面运行测试
npm run test:coverage # 生成覆盖率报告
```

### 生产构建
```bash
npm run build
```

---

## 📚 核心改进速查表

### P0-1：aiService 稳定性

#### 使用 fetchWithRetry
```typescript
import { fetchWithRetry } from '@/lib/aiService'

// 默认参数
const response = await fetchWithRetry(url, init)

// 自定义参数
const response = await fetchWithRetry(url, init, {
  timeoutMs: 60000,
  retries: 3,
  signal: abortController.signal
})
```

#### 使用 ConcurrencyController
```typescript
import { ConcurrencyController } from '@/lib/aiService'

const controller = new ConcurrencyController(2) // 最多 2 个并发
const result = await controller.run(() => asyncTask())
```

#### 使用 buildEndpoint
```typescript
import { buildEndpoint } from '@/lib/aiService'

const url = buildEndpoint('https://api.example.com/', 'chat/completions')
// => 'https://api.example.com/chat/completions'
```

---

### P0-3：样式系统化

#### Button 组件
```tsx
import { Button } from '@/components/ui/button'

// 变体
<Button variant="default">主要操作</Button>
<Button variant="destructive">删除</Button>
<Button variant="outline">次要操作</Button>
<Button variant="secondary">次要</Button>
<Button variant="ghost">幽灵</Button>
<Button variant="link">链接</Button>

// 尺寸
<Button size="sm">小</Button>
<Button size="default">默认</Button>
<Button size="lg">大</Button>
<Button size="icon">图标</Button>
```

#### Input 组件
```tsx
import { Input } from '@/components/ui/input'

// 标准输入
<Input placeholder="输入内容..." />

// 错误状态
<Input variant="destructive" aria-invalid="true" />

// 不同尺寸
<Input size="sm" />
<Input size="default" />
<Input size="lg" />
```

#### Dialog 组件
```tsx
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'

<Dialog open={isOpen} onOpenChange={setIsOpen}>
  <DialogContent size="lg">
    <DialogHeader>
      <DialogTitle>标题</DialogTitle>
    </DialogHeader>
    {/* 内容 */}
  </DialogContent>
</Dialog>
```

---

### P0-4：单元测试

#### 运行特定测试
```bash
npm test -- aiService.test.ts
npm test -- bookmarkUtils.test.ts
npm test -- faviconUtils.test.ts
```

#### 查看测试覆盖率
```bash
npm run test:coverage
```

#### 测试文件位置
- `lib/__tests__/aiService.test.ts` (8 个测试)
- `lib/__tests__/bookmarkUtils.test.ts` (17 个测试)
- `lib/__tests__/faviconUtils.test.ts` (19 个测试)

---

### P0-5：状态组件

#### Skeleton 加载骨架屏
```tsx
import { Skeleton } from '@/components/ui/skeleton'

{isLoading ? (
  <div className="grid gap-4">
    <Skeleton className="h-32 rounded-lg" />
    <Skeleton className="h-32 rounded-lg" />
  </div>
) : (
  <BookmarkList />
)}
```

#### EmptyState 空状态
```tsx
import { EmptyState } from '@/components/ui/empty-state'
import { BookmarkIcon } from 'lucide-react'

{bookmarks.length === 0 && (
  <EmptyState
    icon={<BookmarkIcon />}
    title="No bookmarks"
    description="Add your first bookmark"
    action={<Button onClick={handleAdd}>Add</Button>}
  />
)}
```

#### ErrorState 错误状态
```tsx
import { ErrorState } from '@/components/ui/error-state'

{error && (
  <ErrorState
    title="Failed to load"
    error={error}
    action={<Button onClick={handleRetry}>Retry</Button>}
  />
)}
```

#### ErrorBoundary 错误边界
```tsx
import { ErrorBoundary } from '@/components/error-boundary'

<ErrorBoundary>
  <SettingsPage />
</ErrorBoundary>
```

---

## 🔧 常见任务

### 添加新的 Button 变体
```typescript
// components/ui/button.tsx
const buttonVariants = cva(
  "base-classes",
  {
    variants: {
      variant: {
        // 添加新变体
        custom: "custom-classes"
      }
    }
  }
)
```

### 添加新的 Input 尺寸
```typescript
// components/ui/input.tsx
const inputVariants = cva(
  "base-classes",
  {
    variants: {
      size: {
        // 添加新尺寸
        xl: "h-12 px-5 py-3 text-xl"
      }
    }
  }
)
```

### 添加新的测试
```typescript
// lib/__tests__/myUtils.test.ts
import { describe, it, expect } from 'vitest'

describe('myUtils', () => {
  it('should do something', () => {
    expect(result).toBe(expected)
  })
})
```

---

## 📖 文档导航

### 详细文档
| 文档 | 内容 |
|------|------|
| [P0-1 总结](./P0-1-aiService稳定性改造总结.md) | aiService 改进详情 |
| [P0-3 总结](./P0-3-样式系统化总结.md) | 样式改进详情 |
| [设计系统](./设计系统与组件规范.md) | 完整设计规范 |
| [P0-4 总结](./P0-4-核心逻辑单元测试总结.md) | 测试详情 |
| [P0-5 总结](./P0-5-性能优化与状态组件总结.md) | 状态组件详情 |

### 功能文档
| 文档 | 内容 |
|------|------|
| [NewTab 说明](./NewTab功能说明.md) | 新标签页功能 |
| [Favicon 说明](./Favicon功能说明.md) | 网站图标功能 |

---

## 🐛 故障排除

### 编译错误
```bash
npm run compile
```

### 测试失败
```bash
npm test -- --reporter=verbose
```

### 构建失败
```bash
npm run build -- --debug
```

---

## 💡 最佳实践

### 1. 使用 cva 管理样式
```tsx
// ✅ 好
const buttonVariants = cva("base", { variants: { ... } })

// ❌ 避免
const buttonClass = isActive ? "bg-blue" : "bg-gray"
```

### 2. 添加错误边界
```tsx
// ✅ 好
<ErrorBoundary>
  <CriticalComponent />
</ErrorBoundary>

// ❌ 避免
<CriticalComponent />
```

### 3. 显示加载状态
```tsx
// ✅ 好
{isLoading ? <Skeleton /> : <Content />}

// ❌ 避免
{isLoading && <div>Loading...</div>}
<Content />
```

### 4. 处理空状态
```tsx
// ✅ 好
{items.length === 0 ? <EmptyState /> : <List />}

// ❌ 避免
{items.map(item => <Item key={item.id} {...item} />)}
```

---

## 📞 获取帮助

1. **查看文档**: 参考 `docs/` 目录中的详细文档
2. **查看测试**: 参考 `lib/__tests__/` 中的测试用例
3. **查看示例**: 参考现有组件的实现

---

**最后更新**: 2025-10-16
**版本**: P0 阶段完成


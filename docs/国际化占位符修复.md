# 国际化占位符修复

## 🎯 问题描述

在AI批量重命名页面中，显示"找到 {count} 个书签"时，占位符 `{count}` 没有被实际的数字替换，而是显示为字面的 `{count}`。

## 🔍 问题分析

### 症状
- 翻译文本：`"bookmarksFound": "找到 {count} 个书签"`
- 代码调用：`t('bookmarksFound', { count: bookmarks.length })`
- 实际显示：`"找到 {count} 个书签"` （占位符未替换）
- 期望显示：`"找到 5 个书签"` （占位符被替换为实际数字）

### 根本原因

经过分析发现两个主要问题：

1. **i18n 插值配置缺失**
   - react-i18next 的插值功能没有明确配置
   - 缺少 `interpolation` 配置项

2. **异步初始化问题**
   - `initTranslations` 函数没有使用 `await` 等待完成
   - 组件可能在 i18n 完全初始化前就开始渲染

## ✅ 修复方案

### 1. **添加插值配置**

#### 修改文件：`components/i18n.ts`

**修改前**：
```typescript
await i18nInstance.init({
    lng: locale,
    resources,
    fallbackLng: i18nConfig.defaultLocale,
    supportedLngs: i18nConfig.locales,
    defaultNS: namespaces[0],
    fallbackNS: namespaces[0],
    ns: namespaces,
    preload: resources ? [] : i18nConfig.locales
});
```

**修改后**：
```typescript
await i18nInstance.init({
    lng: locale,
    resources,
    fallbackLng: i18nConfig.defaultLocale,
    supportedLngs: i18nConfig.locales,
    defaultNS: namespaces[0],
    fallbackNS: namespaces[0],
    ns: namespaces,
    preload: resources ? [] : i18nConfig.locales,
    interpolation: {
        escapeValue: false // React already does escaping
    }
});
```

### 2. **修复异步初始化**

#### 修改文件：`entrypoints/newtab/main.tsx`

**修改前**：
```typescript
initTranslations(i18nConfig.defaultLocale,["common","newtab"])

// 初始化强调色
initializeAccentColor().catch(console.error);

ReactDOM.createRoot(document.getElementById('root')!).render(
    <React.StrictMode>
        <ThemeProvider>
            <App/>
        </ThemeProvider>
    </React.StrictMode>,
);
```

**修改后**：
```typescript
async function initApp() {
    // 初始化国际化
    await initTranslations(i18nConfig.defaultLocale, ["common", "newtab"]);
    
    // 初始化强调色
    await initializeAccentColor();
    
    // 渲染应用
    ReactDOM.createRoot(document.getElementById('root')!).render(
        <React.StrictMode>
            <ThemeProvider>
                <App/>
            </ThemeProvider>
        </React.StrictMode>,
    );
}

initApp().catch(console.error);
```

## 🔧 技术原理

### 插值功能

react-i18next 的插值功能允许在翻译文本中使用占位符：

```typescript
// 翻译文件
{
  "bookmarksFound": "找到 {count} 个书签"
}

// 代码中使用
t('bookmarksFound', { count: 5 })
// 结果: "找到 5 个书签"
```

### 配置说明

- **`escapeValue: false`**：禁用HTML转义，因为React已经处理了XSS防护
- **异步初始化**：确保i18n完全加载后再渲染组件

## 🧪 验证方法

### 1. **构建测试**
```bash
npm run build
```
- ✅ 构建成功，无错误

### 2. **功能测试**

在Chrome扩展中测试：

1. **加载扩展**
   - 打开 `chrome://extensions/`
   - 加载 `.output/chrome-mv3` 目录

2. **测试批量重命名页面**
   - 打开扩展的新标签页
   - 点击侧边栏的批量重命名按钮
   - 选择一个包含书签的文件夹

3. **验证占位符替换**
   - ✅ 应显示 "找到 X 个书签"（X为实际数字）
   - ✅ 不应显示 "找到 {count} 个书签"

### 3. **其他占位符测试**

同时验证其他使用占位符的文本：
- `t('batchRenameSuccess', { count: successCount })`
- `t('folderContainsItems', { count: childrenCount })`
- `t('confirmApplyMessage', { count: selectedCount })`

## 📊 影响范围

### 修复的功能
- ✅ 批量重命名页面的书签计数显示
- ✅ 成功重命名的书签计数显示
- ✅ 文件夹包含项目的计数显示
- ✅ 确认应用修改的计数显示

### 不受影响的功能
- ✅ 其他不使用占位符的翻译文本
- ✅ 基本的国际化切换功能
- ✅ 静态翻译文本显示

## 🎉 修复效果

### 修复前
- ❌ 显示：`"找到 {count} 个书签"`
- ❌ 显示：`"已成功重命名 {count} 个书签"`
- ❌ 显示：`"此文件夹包含 {count} 个项目"`

### 修复后
- ✅ 显示：`"找到 5 个书签"`
- ✅ 显示：`"已成功重命名 3 个书签"`
- ✅ 显示：`"此文件夹包含 8 个项目"`

## 🔍 相关文件

- **修改文件**：
  - `components/i18n.ts` - 添加插值配置
  - `entrypoints/newtab/main.tsx` - 修复异步初始化
- **翻译文件**：
  - `locales/zh_CN/common.json` - 中文翻译
  - `locales/en/common.json` - 英文翻译
- **使用文件**：
  - `entrypoints/newtab/batch-rename.tsx` - 批量重命名页面
  - `components/ui/folder-delete-dialog.tsx` - 文件夹删除对话框

## 📝 最佳实践

### 占位符使用规范

```typescript
// ✅ 正确的占位符使用
t('messageWithCount', { count: number, name: string })

// ✅ 翻译文件格式
{
  "messageWithCount": "找到 {count} 个 {name}"
}

// ❌ 避免的写法
t('messageWithCount') + count + '个书签'
```

### i18n 配置建议

```typescript
// ✅ 推荐的配置
interpolation: {
    escapeValue: false, // React环境下禁用HTML转义
    format: function(value, format, lng) {
        // 可以添加自定义格式化逻辑
        if (format === 'number') return new Intl.NumberFormat(lng).format(value);
        return value;
    }
}
```

这次修复确保了所有使用占位符的国际化文本都能正确显示，提升了用户体验的一致性和专业性。

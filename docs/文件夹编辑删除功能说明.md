# 文件夹编辑删除功能说明

## 🎯 功能概述

为Chrome扩展的书签管理功能新增了文件夹的编辑和删除能力，现在用户可以通过右键菜单对文件夹进行重命名和删除操作。

## ✨ 新增功能特性

### 1. **文件夹右键菜单**
- ✅ 文件夹现在支持右键菜单
- ✅ 菜单项根据内容类型显示不同文本：
  - 书签：显示"编辑"和"删除"
  - 文件夹：显示"重命名文件夹"和"删除文件夹"

### 2. **文件夹重命名功能**
- ✅ 专用的文件夹编辑对话框
- ✅ 简洁的界面，只需编辑文件夹名称
- ✅ 实时验证，防止空名称
- ✅ 支持键盘快捷键（Enter保存，Esc取消）

### 3. **文件夹删除功能**
- ✅ 专用的文件夹删除确认对话框
- ✅ 显示文件夹包含的项目数量
- ✅ 特殊警告提示（删除文件夹将删除所有内容）
- ✅ 智能导航处理（删除当前文件夹时自动返回上级）

### 4. **数据同步和状态管理**
- ✅ 与Chrome书签API完全同步
- ✅ 跨页面广播更新
- ✅ 本地状态实时更新
- ✅ 导航历史智能更新

## 🔧 技术实现

### 新增组件

#### 1. **FolderEditDialog** (`components/ui/folder-edit-dialog.tsx`)
```typescript
interface FolderEditDialogProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    folder: BookmarkCardItem | null;
    onSave: (id: string, title: string) => Promise<void>;
}
```

**核心功能**：
- 文件夹名称编辑
- 表单验证
- 键盘快捷键支持
- 错误处理和Toast提示

#### 2. **FolderDeleteDialog** (`components/ui/folder-delete-dialog.tsx`)
```typescript
interface FolderDeleteDialogProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    folder: BookmarkCardItem | null;
    onConfirm: () => void;
    isDeleting?: boolean;
}
```

**核心功能**：
- 删除确认界面
- 显示文件夹内容数量
- 特殊警告提示
- 删除进度状态

### 修改的组件

#### 1. **BookmarkCard** (`components/ui/bookmark-card.tsx`)
**主要修改**：
```typescript
// 修改前：只有书签才显示右键菜单
if (!isFolder && (onEdit || onDelete)) {
    // 显示右键菜单
}

// 修改后：书签和文件夹都显示右键菜单
if (onEdit || onDelete) {
    // 显示右键菜单，根据类型显示不同文本
    {isFolder ? t('renameFolder') : t('edit')}
    {isFolder ? t('deleteFolder') : t('delete')}
}
```

#### 2. **Bookmarks** (`entrypoints/newtab/bookmarks.tsx`)
**新增状态管理**：
```typescript
// 文件夹编辑和删除状态
const [editingFolder, setEditingFolder] = useState<BookmarkCardItem | null>(null);
const [isFolderEditDialogOpen, setIsFolderEditDialogOpen] = useState(false);
const [deletingFolder, setDeletingFolder] = useState<BookmarkCardItem | null>(null);
const [isFolderDeleteDialogOpen, setIsFolderDeleteDialogOpen] = useState(false);
const [isDeletingFolder, setIsDeletingFolder] = useState(false);
```

**智能处理函数**：
```typescript
// 统一的编辑处理（自动识别书签/文件夹）
const handleBookmarkEdit = (item: BookmarkCardItem) => {
    const isFolder = !item.url;
    if (isFolder) {
        setEditingFolder(item);
        setIsFolderEditDialogOpen(true);
    } else {
        setEditingBookmark(item);
        setIsEditDialogOpen(true);
    }
};

// 统一的删除处理（自动识别书签/文件夹）
const handleBookmarkDelete = (item: BookmarkCardItem) => {
    const isFolder = !item.url;
    if (isFolder) {
        setDeletingFolder(item);
        setIsFolderDeleteDialogOpen(true);
    } else {
        setDeletingBookmark(item);
        setIsDeleteDialogOpen(true);
    }
};
```

## 🌐 国际化支持

### 新增翻译文本

#### 中文 (`locales/zh_CN/common.json`)
```json
{
  "renameFolder": "重命名文件夹",
  "deleteFolder": "删除文件夹",
  "editFolder": "编辑文件夹",
  "editFolderDescription": "编辑文件夹名称",
  "folderName": "文件夹名称",
  "folderNamePlaceholder": "输入文件夹名称",
  "folderUpdated": "文件夹已更新",
  "folderUpdatedSuccessfully": "文件夹名称已成功更新",
  "saveFolderFailed": "保存文件夹失败",
  "folderContainsItems": "此文件夹包含 {count} 个项目",
  "deleteFolderConfirm": "确定要删除这个文件夹吗？",
  "deleteFolderDescription": "此操作将删除文件夹及其所有内容，无法撤销",
  "folderDeleted": "文件夹已删除",
  "deleteFolderFailed": "删除文件夹失败",
  "saving": "保存中"
}
```

#### 英文 (`locales/en/common.json`)
```json
{
  "renameFolder": "Rename Folder",
  "deleteFolder": "Delete Folder",
  "editFolder": "Edit Folder",
  "editFolderDescription": "Edit folder name",
  "folderName": "Folder Name",
  "folderNamePlaceholder": "Enter folder name",
  "folderUpdated": "Folder updated",
  "folderUpdatedSuccessfully": "Folder name updated successfully",
  "saveFolderFailed": "Failed to save folder",
  "folderContainsItems": "This folder contains {count} items",
  "deleteFolderConfirm": "Are you sure you want to delete this folder?",
  "deleteFolderDescription": "This action will delete the folder and all its contents, and cannot be undone",
  "folderDeleted": "Folder deleted",
  "deleteFolderFailed": "Failed to delete folder",
  "saving": "Saving"
}
```

## 🧪 使用场景和测试

### 1. **文件夹重命名**
#### 操作步骤：
1. 右键点击任意文件夹
2. 选择"重命名文件夹"
3. 在弹出的对话框中修改名称
4. 点击"保存"或按Enter键

#### 预期结果：
- ✅ 文件夹名称立即更新
- ✅ 导航历史中的名称同步更新
- ✅ 显示成功提示
- ✅ 对话框自动关闭

### 2. **文件夹删除**
#### 操作步骤：
1. 右键点击任意文件夹
2. 选择"删除文件夹"
3. 查看确认对话框中的警告信息
4. 点击"删除"确认

#### 预期结果：
- ✅ 文件夹及其所有内容被删除
- ✅ 如果删除的是当前文件夹，自动返回上级
- ✅ 显示删除成功提示
- ✅ 页面交互立即恢复正常

### 3. **错误处理**
#### 测试场景：
- 空文件夹名称：显示验证错误
- 网络错误：显示操作失败提示
- 权限错误：显示相应错误信息

## 🔍 Portal清理机制

### 问题预防
为了避免之前遇到的对话框关闭后页面无法交互的问题，文件夹编辑和删除对话框都实现了相同的Portal清理机制：

```typescript
// 强制清理可能残留的Portal元素
setTimeout(() => {
    // 清理空的Radix Portal元素
    const portals = document.querySelectorAll('[data-radix-portal]');
    portals.forEach(portal => {
        if (portal.children.length === 0) {
            portal.remove();
        }
    });
    
    // 清理已关闭的overlay元素
    const overlays = document.querySelectorAll('[data-slot="dialog-overlay"]');
    overlays.forEach(overlay => {
        if (overlay.getAttribute('data-state') === 'closed') {
            overlay.remove();
        }
    });
    
    // 重置body样式
    document.body.style.pointerEvents = '';
}, 300);
```

## 📊 构建信息

- **版本**: 文件夹编辑删除功能版本 v1.0
- **大小**: 982.98 kB
- **文件**: `newtab-BOMwgWEQ.js`
- **状态**: 构建成功，功能完整

## 🎯 功能优势

### 1. **完整的文件夹管理**
- 现在文件夹和书签享有同等的管理能力
- 统一的交互体验

### 2. **智能用户体验**
- 根据内容类型显示合适的菜单文本
- 删除文件夹时显示内容数量警告
- 删除当前文件夹时自动导航

### 3. **数据一致性**
- 与Chrome书签API完全同步
- 跨页面状态同步
- 导航历史智能更新

### 4. **错误处理**
- 完善的表单验证
- 友好的错误提示
- 操作失败时的回滚机制

## 🚀 测试建议

### 基础功能测试
1. **重新加载扩展**
2. **测试文件夹重命名**：
   - 右键文件夹 → 重命名 → 修改名称 → 保存
   - 验证名称更新和导航历史同步
3. **测试文件夹删除**：
   - 右键文件夹 → 删除 → 确认删除
   - 验证文件夹删除和导航处理
4. **测试错误场景**：
   - 尝试保存空名称
   - 取消操作
   - 验证页面交互正常

### 交互测试
1. **对话框关闭后立即测试**：
   - 点击其他书签/文件夹
   - 右键其他项目
   - 验证所有交互正常

现在文件夹管理功能已经完全实现，用户可以享受完整的书签和文件夹管理体验！🎉

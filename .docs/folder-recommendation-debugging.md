# 文件夹推荐功能调试指南

## 问题现象

在使用智能文件夹推荐功能时，可能会遇到"无法解析推荐结果，使用默认文件夹"的提示。

## 调试步骤

### 1. 查看控制台日志

打开 Chrome 扩展的 Popup 窗口后，按 `F12` 或右键点击 Popup 窗口选择"检查"，打开开发者工具。

在控制台中查找以下日志：

```
[FolderRecommendation] AI 原始响应: ...
[FolderRecommendation] 清理后的响应: ...
[FolderRecommendation] 解析后的 JSON: ...
```

### 2. 检查 AI 响应格式

#### 正确的响应格式（多推荐模式）

```json
[
  {"index": 1, "reason": "GitHub 项目属于前端开发", "confidence": 0.9},
  {"index": 2, "reason": "可能涉及后端技术", "confidence": 0.7},
  {"index": 3, "reason": "可作为学习参考", "confidence": 0.6}
]
```

#### 正确的响应格式（单推荐模式）

```json
{"index": 1, "reason": "推荐理由", "confidence": 0.9}
```

或者只返回数字：

```
1
```

### 3. 常见问题和解决方案

#### 问题 1: AI 返回了额外的文本

**症状：** 控制台显示类似这样的响应：
```
根据页面信息，我推荐以下文件夹：
[{"index": 1, "reason": "...", "confidence": 0.9}]
```

**解决方案：** 
- 已在代码中添加了自动清理逻辑，会提取 JSON 数组部分
- 如果仍然失败，请检查 AI 配置中的 Prompt 设置

#### 问题 2: AI 返回了 Markdown 代码块

**症状：** 控制台显示类似这样的响应：
```
```json
[{"index": 1, "reason": "...", "confidence": 0.9}]
```
```

**解决方案：**
- 已在代码中添加了自动清理逻辑，会移除 Markdown 代码块标记
- 如果仍然失败，请检查 AI 模型设置

#### 问题 3: 索引超出范围

**症状：** 控制台显示：
```
[FolderRecommendation] 索引 10 超出范围，文件夹总数: 5
```

**解决方案：**
- AI 返回的索引超出了可用文件夹的数量
- 这通常是 AI 模型理解错误，建议：
  1. 检查 Prompt 是否正确传递了文件夹列表
  2. 尝试减少文件夹数量或简化文件夹名称
  3. 调整 AI 模型的 temperature 参数（降低到 0.1-0.3）

#### 问题 4: JSON 解析失败

**症状：** 控制台显示：
```
[FolderRecommendation] JSON 解析失败: SyntaxError: ...
[FolderRecommendation] 失败的响应文本: ...
```

**解决方案：**
1. 检查 AI 返回的 JSON 格式是否正确
2. 常见的 JSON 错误：
   - 缺少引号：`{index: 1}` 应该是 `{"index": 1}`
   - 多余的逗号：`[{...},]` 应该是 `[{...}]`
   - 单引号：`{'index': 1}` 应该是 `{"index": 1}`
3. 如果 AI 持续返回错误格式，建议：
   - 在设置中编辑 Prompt，强调"只返回 JSON，不要其他文本"
   - 尝试更换 AI 模型（推荐使用 GPT-4 或 Claude）

### 4. 优化建议

#### 调整 AI 配置

在设置页面（AI 设置）中：

1. **Temperature（温度）**：建议设置为 `0.1-0.3`
   - 较低的温度会让 AI 更加确定性，减少格式错误

2. **Max Tokens（最大令牌数）**：建议设置为 `150-300`
   - 足够返回推荐结果，但不会太长导致包含额外文本

3. **最大推荐数量**：建议设置为 `1-3`
   - 推荐数量越少，AI 越容易返回正确格式
   - 如果经常失败，可以先设置为 1 测试

#### 自定义 Prompt

如果默认 Prompt 效果不好，可以在设置中自定义 Prompt。关键要点：

1. **明确要求只返回 JSON**
   ```
   重要：只返回 JSON 数组，不要任何其他文本或解释。
   ```

2. **提供明确的格式示例**
   ```
   格式必须严格遵循：
   [{"index": 1, "reason": "推荐理由", "confidence": 0.9}]
   ```

3. **强调索引范围**
   ```
   index 是文件夹列表中的序号（从 1 开始），0 表示默认书签栏。
   ```

### 5. 测试流程

1. **启用详细日志**
   - 打开 Popup 的开发者工具
   - 确保控制台显示所有日志级别

2. **测试简单场景**
   - 选择一个明确的网站（如 GitHub、知乎）
   - 确保有相关的文件夹（如"开发"、"学习"）
   - 观察 AI 的推荐结果

3. **逐步增加复杂度**
   - 从 1 个推荐开始测试
   - 成功后增加到 2-3 个推荐
   - 测试不同类型的网站

### 6. 常见 AI 模型兼容性

| AI 模型 | 兼容性 | 建议配置 |
|---------|--------|----------|
| GPT-4 | ✅ 优秀 | Temperature: 0.2, Max Tokens: 200 |
| GPT-3.5 | ✅ 良好 | Temperature: 0.1, Max Tokens: 150 |
| Claude 3 | ✅ 优秀 | Temperature: 0.2, Max Tokens: 200 |
| 通义千问 | ⚠️ 一般 | 可能需要自定义 Prompt |
| 文心一言 | ⚠️ 一般 | 可能需要自定义 Prompt |
| 本地模型 | ⚠️ 视模型而定 | 建议使用指令微调模型 |

### 7. 降级策略

如果 AI 推荐持续失败，系统会自动降级到默认书签栏（ID: '1'），不会影响正常添加书签功能。

可以在设置中关闭"失败时降级到默认文件夹"选项，这样失败时会显示错误提示而不是静默降级。

## 反馈问题

如果按照以上步骤仍然无法解决问题，请提供以下信息：

1. 控制台中的完整日志（包括 AI 原始响应）
2. 使用的 AI 模型和配置
3. 测试的网站 URL
4. 文件夹列表结构

这些信息将帮助我们诊断和解决问题。


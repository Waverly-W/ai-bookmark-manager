# é…ç½®åŒæ­¥åŠŸèƒ½ - å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### Storage ç±»å‹å¯¹æ¯”

| ç‰¹æ€§ | storage.local | storage.sync |
|------|--------------|-------------|
| **å­˜å‚¨ä½ç½®** | æœ¬åœ°è®¾å¤‡ | Google æœåŠ¡å™¨ + æœ¬åœ°ç¼“å­˜ |
| **å®¹é‡** | 10MB | 100KB |
| **åŒæ­¥èŒƒå›´** | æ—  | è·¨è®¾å¤‡ |
| **è®¿é—®é€Ÿåº¦** | å¿« | å¿«ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰ |
| **ç¦»çº¿æ”¯æŒ** | âœ… | âœ… |
| **ç”¨é€”** | ä¸´æ—¶æ•°æ®ã€ç¼“å­˜ | ç”¨æˆ·é…ç½®ã€åå¥½è®¾ç½® |

---

## ğŸ“ API ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€æ“ä½œ

```typescript
import { configSyncManager } from '@/lib/configSyncManager';

// åˆå§‹åŒ–ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
await configSyncManager.initialize();

// ä¿å­˜é…ç½®ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰
await configSyncManager.saveConfig('theme', 'dark');

// è¯»å–é…ç½®
const theme = await configSyncManager.getConfig('theme');

// è·å–åŒæ­¥çŠ¶æ€
const status = configSyncManager.getSyncStatus();
console.log(status);
// {
//   isSyncing: false,
//   lastSyncTime: 1234567890,
//   lastError: null,
//   pendingChanges: 0
// }

// æ‰‹åŠ¨åŒæ­¥
await configSyncManager.manualSync();

// ç›‘å¬åŒæ­¥å˜æ›´
configSyncManager.onSyncChange((changes) => {
  console.log('é…ç½®å·²æ›´æ–°:', changes);
});
```

---

## ğŸ”§ é›†æˆæ­¥éª¤

### 1. åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–

```typescript
// entrypoints/newtab/main.tsx
import { configSyncManager } from '@/lib/configSyncManager';

async function initApp() {
  // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
  await configSyncManager.initialize();
  
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
}

initApp().catch(console.error);
```

### 2. ä¿®æ”¹é…ç½®ä¿å­˜å‡½æ•°

```typescript
// ä¹‹å‰
export const saveAIConfig = async (config: AIConfig): Promise<void> => {
  await browser.storage.local.set({ aiConfig: config });
};

// ä¹‹å
import { configSyncManager } from '@/lib/configSyncManager';

export const saveAIConfig = async (config: AIConfig): Promise<void> => {
  await configSyncManager.saveConfig('aiConfig', config);
};
```

### 3. ä¿®æ”¹é…ç½®è¯»å–å‡½æ•°

```typescript
// ä¹‹å‰
export const getAIConfig = async (): Promise<AIConfig> => {
  const result = await browser.storage.local.get('aiConfig');
  return result.aiConfig || defaultConfig;
};

// ä¹‹å
import { configSyncManager } from '@/lib/configSyncManager';

export const getAIConfig = async (): Promise<AIConfig> => {
  const config = await configSyncManager.getConfig('aiConfig');
  return config || defaultConfig;
};
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å•è®¾å¤‡é…ç½®ä¿å­˜
```
1. æ‰“å¼€æ‰©å±•è®¾ç½®
2. ä¿®æ”¹ AI é…ç½®
3. ç‚¹å‡»ä¿å­˜
4. éªŒè¯é…ç½®å·²ä¿å­˜
5. åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯é…ç½®ä»å­˜åœ¨
```

### åœºæ™¯ 2: è·¨è®¾å¤‡åŒæ­¥
```
è®¾å¤‡A:
1. ç™»å½• Chrome è´¦æˆ·
2. å®‰è£…æ‰©å±•
3. ä¿®æ”¹ä¸»é¢˜ä¸º dark
4. ç­‰å¾… 2 ç§’

è®¾å¤‡B:
1. ç™»å½•åŒä¸€ Chrome è´¦æˆ·
2. å®‰è£…æ‰©å±•
3. éªŒè¯ä¸»é¢˜è‡ªåŠ¨å˜ä¸º dark
```

### åœºæ™¯ 3: å†²çªè§£å†³
```
è®¾å¤‡A:
1. ä¿®æ”¹ API Key ä¸º "key-a"
2. ä¸ä¿å­˜

è®¾å¤‡B:
1. ä¿®æ”¹ API Key ä¸º "key-b"
2. ä¿å­˜

è®¾å¤‡A:
1. ä¿å­˜ "key-a"
2. éªŒè¯å†²çªè§£å†³ï¼ˆåº”è¯¥æ˜¯ key-bï¼Œå› ä¸ºæ—¶é—´æˆ³æ›´æ–°ï¼‰
```

### åœºæ™¯ 4: ç¦»çº¿ä½¿ç”¨
```
1. åœ¨çº¿ä¿®æ”¹é…ç½®
2. æ–­ç½‘
3. ä¿®æ”¹å…¶ä»–é…ç½®
4. éªŒè¯æœ¬åœ°é…ç½®æ­£å¸¸å·¥ä½œ
5. æ¢å¤ç½‘ç»œ
6. éªŒè¯é…ç½®è‡ªåŠ¨åŒæ­¥
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### Q: é…ç½®æ²¡æœ‰åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡
**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ä¸¤å°è®¾å¤‡æ˜¯å¦ç™»å½•åŒä¸€ Chrome è´¦æˆ·ï¼Ÿ
2. æ˜¯å¦å¯ç”¨äº† Chrome åŒæ­¥åŠŸèƒ½ï¼Ÿ
3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ
4. ç­‰å¾… 2-3 ç§’ï¼ŒåŒæ­¥æœ‰å»¶è¿Ÿ

### Q: åŒæ­¥çŠ¶æ€æ˜¾ç¤ºé”™è¯¯
**A:** 
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
2. å°è¯•æ‰‹åŠ¨åŒæ­¥
3. æ£€æŸ¥ storage.sync æ˜¯å¦æœ‰å†™å…¥æƒé™

### Q: é…ç½®ä¸¢å¤±
**A:**
1. æ£€æŸ¥ storage.local ä¸­æ˜¯å¦æœ‰å¤‡ä»½
2. æŸ¥çœ‹åŒæ­¥å†å²æ—¥å¿—
3. å°è¯•ä»å…¶ä»–è®¾å¤‡æ¢å¤

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹å­˜å‚¨å†…å®¹

```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ
chrome.storage.local.get(null, (items) => {
  console.log('Local Storage:', items);
});

chrome.storage.sync.get(null, (items) => {
  console.log('Sync Storage:', items);
});
```

### ç›‘å¬å­˜å‚¨å˜æ›´

```typescript
chrome.storage.onChanged.addListener((changes, areaName) => {
  console.log(`${areaName} å­˜å‚¨å·²æ›´æ”¹:`, changes);
});
```

### è·å–åŒæ­¥çŠ¶æ€

```typescript
import { configSyncManager } from '@/lib/configSyncManager';

const status = configSyncManager.getSyncStatus();
console.log('åŒæ­¥çŠ¶æ€:', status);
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. API Key åŠ å¯†
```typescript
// æ•æ„Ÿä¿¡æ¯åº”è¯¥åŠ å¯†å­˜å‚¨
const encryptedKey = btoa(apiKey); // ç®€å•ç¤ºä¾‹
await configSyncManager.saveConfig('apiKey', encryptedKey);
```

### 2. æƒé™æœ€å°åŒ–
```json
{
  "permissions": ["storage", "tabs", "contextMenus", "bookmarks"]
}
```

### 3. å®šæœŸå®¡è®¡
- æ£€æŸ¥ storage.sync ä¸­çš„æ•°æ®
- éªŒè¯æ²¡æœ‰æ³„éœ²æ•æ„Ÿä¿¡æ¯
- ç›‘æ§å¼‚å¸¸çš„åŒæ­¥æ´»åŠ¨

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ“ä½œ
```typescript
// âŒ ä¸å¥½ï¼šå¤šæ¬¡è°ƒç”¨
await configSyncManager.saveConfig('theme', 'dark');
await configSyncManager.saveConfig('locale', 'zh_CN');

// âœ… å¥½ï¼šåˆå¹¶æ“ä½œ
const config = {
  theme: 'dark',
  locale: 'zh_CN'
};
// åœ¨ ConfigSyncManager ä¸­å®ç°æ‰¹é‡ä¿å­˜
```

### 2. ç¼“å­˜ç­–ç•¥
```typescript
// ä½¿ç”¨æœ¬åœ°å˜é‡ç¼“å­˜é¢‘ç¹è®¿é—®çš„é…ç½®
let cachedTheme: string | null = null;

export const getTheme = async (): Promise<string> => {
  if (cachedTheme) return cachedTheme;
  cachedTheme = await configSyncManager.getConfig('theme');
  return cachedTheme;
};
```

### 3. å»¶è¿ŸåŒæ­¥
```typescript
// é˜²æ­¢é¢‘ç¹åŒæ­¥
let syncTimeout: NodeJS.Timeout | null = null;

const debouncedSync = async (key: string, value: any) => {
  if (syncTimeout) clearTimeout(syncTimeout);
  
  syncTimeout = setTimeout(async () => {
    await configSyncManager.saveConfig(key, value);
  }, 1000);
};
```

---

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰é…ç½®é¡¹å·²è¿ç§»åˆ° configSyncManager
- [ ] åˆå§‹åŒ–ä»£ç å·²æ·»åŠ åˆ°åº”ç”¨å¯åŠ¨æµç¨‹
- [ ] UI ç»„ä»¶å·²æ·»åŠ åŒæ­¥çŠ¶æ€æ˜¾ç¤º
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] å¤šè®¾å¤‡æ‰‹åŠ¨æµ‹è¯•é€šè¿‡
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] ç”¨æˆ·é€šçŸ¥å·²å‡†å¤‡

---

## ğŸ“ è·å–å¸®åŠ©

### æ–‡æ¡£
- é…ç½®åŒæ­¥åŠŸèƒ½è§„åˆ’ï¼š`.docs/é…ç½®åŒæ­¥åŠŸèƒ½è§„åˆ’.md`
- å®ç°æŒ‡å—ï¼š`.docs/é…ç½®åŒæ­¥å®ç°æŒ‡å—.md`
- æ–¹æ¡ˆå¯¹æ¯”ï¼š`.docs/åŒæ­¥æ–¹æ¡ˆå¯¹æ¯”åˆ†æ.md`

### ä»£ç ç¤ºä¾‹
- æŸ¥çœ‹ `lib/configSyncManager.ts`
- æŸ¥çœ‹ `components/settings/sync-status-settings.tsx`

### è°ƒè¯•
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- æŸ¥çœ‹ Chrome æ‰©å±•æ—¥å¿—
- æ£€æŸ¥ storage å†…å®¹



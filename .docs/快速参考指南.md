# 配置同步功能 - 快速参考指南

## 🎯 核心概念

### Storage 类型对比

| 特性 | storage.local | storage.sync |
|------|--------------|-------------|
| **存储位置** | 本地设备 | Google 服务器 + 本地缓存 |
| **容量** | 10MB | 100KB |
| **同步范围** | 无 | 跨设备 |
| **访问速度** | 快 | 快（本地缓存） |
| **离线支持** | ✅ | ✅ |
| **用途** | 临时数据、缓存 | 用户配置、偏好设置 |

---

## 📝 API 使用示例

### 基础操作

```typescript
import { configSyncManager } from '@/lib/configSyncManager';

// 初始化（应用启动时调用一次）
await configSyncManager.initialize();

// 保存配置（自动同步）
await configSyncManager.saveConfig('theme', 'dark');

// 读取配置
const theme = await configSyncManager.getConfig('theme');

// 获取同步状态
const status = configSyncManager.getSyncStatus();
console.log(status);
// {
//   isSyncing: false,
//   lastSyncTime: 1234567890,
//   lastError: null,
//   pendingChanges: 0
// }

// 手动同步
await configSyncManager.manualSync();

// 监听同步变更
configSyncManager.onSyncChange((changes) => {
  console.log('配置已更新:', changes);
});
```

---

## 🔧 集成步骤

### 1. 在应用启动时初始化

```typescript
// entrypoints/newtab/main.tsx
import { configSyncManager } from '@/lib/configSyncManager';

async function initApp() {
  // 初始化同步管理器
  await configSyncManager.initialize();
  
  // ... 其他初始化代码
}

initApp().catch(console.error);
```

### 2. 修改配置保存函数

```typescript
// 之前
export const saveAIConfig = async (config: AIConfig): Promise<void> => {
  await browser.storage.local.set({ aiConfig: config });
};

// 之后
import { configSyncManager } from '@/lib/configSyncManager';

export const saveAIConfig = async (config: AIConfig): Promise<void> => {
  await configSyncManager.saveConfig('aiConfig', config);
};
```

### 3. 修改配置读取函数

```typescript
// 之前
export const getAIConfig = async (): Promise<AIConfig> => {
  const result = await browser.storage.local.get('aiConfig');
  return result.aiConfig || defaultConfig;
};

// 之后
import { configSyncManager } from '@/lib/configSyncManager';

export const getAIConfig = async (): Promise<AIConfig> => {
  const config = await configSyncManager.getConfig('aiConfig');
  return config || defaultConfig;
};
```

---

## 🧪 测试场景

### 场景 1: 单设备配置保存
```
1. 打开扩展设置
2. 修改 AI 配置
3. 点击保存
4. 验证配置已保存
5. 刷新页面，验证配置仍存在
```

### 场景 2: 跨设备同步
```
设备A:
1. 登录 Chrome 账户
2. 安装扩展
3. 修改主题为 dark
4. 等待 2 秒

设备B:
1. 登录同一 Chrome 账户
2. 安装扩展
3. 验证主题自动变为 dark
```

### 场景 3: 冲突解决
```
设备A:
1. 修改 API Key 为 "key-a"
2. 不保存

设备B:
1. 修改 API Key 为 "key-b"
2. 保存

设备A:
1. 保存 "key-a"
2. 验证冲突解决（应该是 key-b，因为时间戳更新）
```

### 场景 4: 离线使用
```
1. 在线修改配置
2. 断网
3. 修改其他配置
4. 验证本地配置正常工作
5. 恢复网络
6. 验证配置自动同步
```

---

## 🐛 常见问题排查

### Q: 配置没有同步到其他设备
**A:** 检查以下几点：
1. 两台设备是否登录同一 Chrome 账户？
2. 是否启用了 Chrome 同步功能？
3. 网络连接是否正常？
4. 等待 2-3 秒，同步有延迟

### Q: 同步状态显示错误
**A:** 
1. 检查浏览器控制台是否有错误信息
2. 尝试手动同步
3. 检查 storage.sync 是否有写入权限

### Q: 配置丢失
**A:**
1. 检查 storage.local 中是否有备份
2. 查看同步历史日志
3. 尝试从其他设备恢复

---

## 📊 监控和调试

### 查看存储内容

```typescript
// 在浏览器控制台运行
chrome.storage.local.get(null, (items) => {
  console.log('Local Storage:', items);
});

chrome.storage.sync.get(null, (items) => {
  console.log('Sync Storage:', items);
});
```

### 监听存储变更

```typescript
chrome.storage.onChanged.addListener((changes, areaName) => {
  console.log(`${areaName} 存储已更改:`, changes);
});
```

### 获取同步状态

```typescript
import { configSyncManager } from '@/lib/configSyncManager';

const status = configSyncManager.getSyncStatus();
console.log('同步状态:', status);
```

---

## 🔐 安全建议

### 1. API Key 加密
```typescript
// 敏感信息应该加密存储
const encryptedKey = btoa(apiKey); // 简单示例
await configSyncManager.saveConfig('apiKey', encryptedKey);
```

### 2. 权限最小化
```json
{
  "permissions": ["storage", "tabs", "contextMenus", "bookmarks"]
}
```

### 3. 定期审计
- 检查 storage.sync 中的数据
- 验证没有泄露敏感信息
- 监控异常的同步活动

---

## 📈 性能优化

### 1. 批量操作
```typescript
// ❌ 不好：多次调用
await configSyncManager.saveConfig('theme', 'dark');
await configSyncManager.saveConfig('locale', 'zh_CN');

// ✅ 好：合并操作
const config = {
  theme: 'dark',
  locale: 'zh_CN'
};
// 在 ConfigSyncManager 中实现批量保存
```

### 2. 缓存策略
```typescript
// 使用本地变量缓存频繁访问的配置
let cachedTheme: string | null = null;

export const getTheme = async (): Promise<string> => {
  if (cachedTheme) return cachedTheme;
  cachedTheme = await configSyncManager.getConfig('theme');
  return cachedTheme;
};
```

### 3. 延迟同步
```typescript
// 防止频繁同步
let syncTimeout: NodeJS.Timeout | null = null;

const debouncedSync = async (key: string, value: any) => {
  if (syncTimeout) clearTimeout(syncTimeout);
  
  syncTimeout = setTimeout(async () => {
    await configSyncManager.saveConfig(key, value);
  }, 1000);
};
```

---

## 🚀 部署检查清单

- [ ] 所有配置项已迁移到 configSyncManager
- [ ] 初始化代码已添加到应用启动流程
- [ ] UI 组件已添加同步状态显示
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 多设备手动测试通过
- [ ] 错误处理完善
- [ ] 文档已更新
- [ ] 用户通知已准备

---

## 📞 获取帮助

### 文档
- 配置同步功能规划：`.docs/配置同步功能规划.md`
- 实现指南：`.docs/配置同步实现指南.md`
- 方案对比：`.docs/同步方案对比分析.md`

### 代码示例
- 查看 `lib/configSyncManager.ts`
- 查看 `components/settings/sync-status-settings.tsx`

### 调试
- 使用浏览器开发者工具
- 查看 Chrome 扩展日志
- 检查 storage 内容



# AI书签管家 - 配置同步功能规划文档

## 📚 文档导航

本目录包含配置同步功能的完整规划和实现指南。

### 📄 文档清单

1. **配置同步功能规划.md** ⭐ 必读
   - 功能概述和核心目标
   - 架构设计和存储策略
   - 同步流程详解
   - 冲突解决策略
   - 实现步骤和后续优化

2. **配置同步实现指南.md** 👨‍💻 开发者必读
   - 详细的代码实现
   - ConfigSyncManager 类设计
   - 现有模块集成方案
   - UI 组件实现
   - 完整的代码示例

3. **同步方案对比分析.md** 📊 架构决策参考
   - 与其他方案的对比
   - Chrome Storage Sync 的优势和限制
   - 安全性分析
   - 存储容量分析
   - 最佳实践

4. **快速参考指南.md** 🚀 快速上手
   - API 使用示例
   - 集成步骤
   - 测试场景
   - 常见问题排查
   - 性能优化建议

---

## 🎯 功能概述

### 核心功能
使用 Chrome 浏览器的账户数据同步功能，实现同一 Google 账户下不同设备间的配置自动同步。

### 同步的配置项
- ✅ AI 配置（API URL、Key、Model ID）
- ✅ 主题设置（明亮/暗黑）
- ✅ 强调色设置
- ✅ 界面语言
- ✅ 自定义 Prompt

### 不同步的配置项
- ❌ 书签根目录（设备特定）
- ❌ 临时数据和缓存
- ❌ 同步状态信息

---

## 🏗️ 架构概览

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层                              │
│  (Settings Components, Theme Provider, etc.)            │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              配置管理层 (ConfigSyncManager)               │
│  - 同步状态管理                                           │
│  - 冲突解决                                               │
│  - 元数据管理                                             │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
┌───────▼──────────┐    ┌────────▼──────────┐
│ storage.local    │    │ storage.sync      │
│ (本地存储)       │    │ (Google 服务器)   │
│ - 缓存           │    │ - 配置            │
│ - 临时数据       │    │ - 元数据          │
└──────────────────┘    └───────────────────┘
```

---

## 📋 实现路线图

### Phase 1: 基础同步 (当前规划)
- [ ] 创建 `lib/configSyncManager.ts`
- [ ] 集成 Chrome Storage Sync API
- [ ] 修改现有配置工具函数
- [ ] 添加同步状态 UI 组件
- [ ] 编写单元测试

**预计工作量**：3-5 天

### Phase 2: 增强功能
- [ ] 冲突解决优化
- [ ] 同步历史记录
- [ ] 选择性同步
- [ ] 性能优化

**预计工作量**：2-3 天

### Phase 3: 高级功能
- [ ] 设备管理
- [ ] 配置备份/恢复
- [ ] 导入/导出
- [ ] 多账户支持

**预计工作量**：3-5 天

---

## 🔑 关键设计决策

### 1. 为什么选择 Chrome Storage Sync？

| 优势 | 说明 |
|------|------|
| **零维护** | 无需维护服务器 |
| **安全可靠** | Google 加密存储 |
| **用户友好** | 与 Chrome 账户集成 |
| **自动同步** | 无需用户操作 |
| **离线支持** | 本地缓存可用 |

### 2. 冲突解决策略

采用**最后修改时间优先**的策略：
1. 比较时间戳（最新的获胜）
2. 如果时间戳相同，比较版本号
3. 如果版本号相同，比较设备 ID（字典序）

### 3. 存储分层

- **storage.sync**：用户配置（需要跨设备同步）
- **storage.local**：本地数据（不需要同步）

---

## 💻 技术栈

- **API**：Chrome Storage API (storage.sync)
- **框架**：WXT + React + TypeScript
- **存储**：browser.storage.sync / browser.storage.local
- **测试**：Vitest

---

## 🧪 测试策略

### 单元测试
- 冲突解决逻辑
- 元数据管理
- 状态转换

### 集成测试
- 本地修改 → 同步
- 远程修改 → 应用
- 冲突场景

### 手动测试
- 两台设备同时修改
- 网络中断恢复
- 扩展卸载重装

---

## 📊 存储容量分析

### 当前配置大小
```
AI 配置:        ~170 bytes
主题设置:       ~30 bytes
Prompt 设置:    ~505 bytes
元数据:         ~600 bytes
─────────────────────────
总计:           ~1.3 KB
```

**结论**：远低于 100KB 限制，有充足空间

---

## 🔐 安全考虑

### 已实现
- ✅ API Key Base64 编码
- ✅ 使用 Chrome 账户认证
- ✅ HTTPS 传输

### 建议改进
- 🔄 使用 Web Crypto API 加密敏感信息
- 🔄 实现权限最小化
- 🔄 定期安全审计

---

## 📖 使用指南

### 对于开发者

1. **快速开始**
   - 阅读 `快速参考指南.md`
   - 查看代码示例
   - 运行测试

2. **深入理解**
   - 阅读 `配置同步功能规划.md`
   - 阅读 `配置同步实现指南.md`
   - 研究 ConfigSyncManager 实现

3. **架构决策**
   - 阅读 `同步方案对比分析.md`
   - 了解为什么选择 Chrome Storage Sync
   - 理解权衡和限制

### 对于用户

- 配置会自动同步到所有登录同一 Google 账户的设备
- 无需手动操作
- 支持手动同步按钮
- 显示同步状态和最后同步时间

---

## 🚀 快速开始

### 1. 理解架构
```bash
# 阅读规划文档
cat .docs/配置同步功能规划.md
```

### 2. 查看实现
```bash
# 查看实现指南
cat .docs/配置同步实现指南.md
```

### 3. 开始开发
```bash
# 参考快速参考指南
cat .docs/快速参考指南.md
```

---

## 📞 常见问题

### Q: 配置会立即同步吗？
A: 通常 1-2 秒内同步，网络不稳定时可能延迟。

### Q: 离线时配置会丢失吗？
A: 不会，本地有缓存，网络恢复后自动同步。

### Q: 支持哪些浏览器？
A: Chrome、Edge 等 Chromium 浏览器。Firefox 需要单独方案。

### Q: 如何处理冲突？
A: 自动采用最后修改时间的配置。

---

## 📝 文档维护

这些文档应该在以下情况下更新：
- [ ] 实现新功能时
- [ ] 发现新的限制或问题时
- [ ] 用户反馈时
- [ ] 定期审查（每季度）

---

## 🔗 相关资源

- [Chrome Storage API 文档](https://developer.chrome.com/docs/extensions/reference/storage/)
- [Chrome 扩展开发指南](https://developer.chrome.com/docs/extensions/mv3/)
- [WXT 文档](https://wxt.dev/)

---

## 📄 许可证

本规划文档属于 AI 书签管家项目的一部分。

---

**最后更新**：2024-10-24
**版本**：1.0
**状态**：规划完成，待实现


